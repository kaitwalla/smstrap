<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmsSink - API Credentials</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <img src="/logo.png" alt="SmsSink Logo" class="h-10 w-10 object-contain">
                    <h1 class="text-3xl font-bold text-gray-800">API Credentials</h1>
                </div>
                <a 
                    href="/"
                    class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                >
                    Back to Messages
                </a>
            </div>

            <div class="space-y-6">
                <!-- Current Credentials -->
                <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3">Current API Credentials</h2>
                    <div id="credentialsDisplay" class="bg-white p-4 rounded mb-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700">API Key:</label>
                                <code id="currentApiKey" class="text-sm bg-gray-100 px-3 py-2 rounded block mt-1 font-mono break-all">Loading...</code>
                                <p id="lastUpdated" class="text-xs text-gray-500 mt-1"></p>
                            </div>
                            <button 
                                id="copyBtn" 
                                class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 transition-colors"
                                onclick="copyApiKey()"
                            >
                                Copy
                            </button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded">
                        <h3 class="text-sm font-semibold text-gray-800 mb-3">Update API Key</h3>
                        <form id="credentialsForm" class="space-y-3">
                            <div>
                                <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-1">New API Key</label>
                                <input 
                                    type="text" 
                                    id="apiKeyInput" 
                                    name="api_key"
                                    placeholder="Enter new API key"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                />
                            </div>
                            <button 
                                type="submit"
                                class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                            >
                                Save API Key
                            </button>
                        </form>
                        <div id="saveStatus" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <!-- API Endpoint -->
                <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">API Endpoint</h2>
                    <code class="text-sm bg-white px-3 py-2 rounded block">http://localhost:23456/v2/messages</code>
                </div>

                <!-- Authorization -->
                <div class="border-l-4 border-purple-500 bg-purple-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Authorization Header</h2>
                    <p class="text-sm text-gray-600 mb-2">Use the API key configured above in the Authorization header. The mock server validates requests against this stored credential.</p>
                    <code id="authExample" class="text-sm bg-white px-3 py-2 rounded block">Authorization: Bearer <span id="authKeyPlaceholder">your-api-key</span></code>
                    <p class="text-xs text-gray-500 mt-2">You can use either <code class="bg-gray-100 px-1 rounded">Bearer &lt;key&gt;</code> or just <code class="bg-gray-100 px-1 rounded">&lt;key&gt;</code> format.</p>
                </div>

                <!-- Example cURL -->
                <div class="border-l-4 border-purple-500 bg-purple-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Example cURL Request</h2>
                    <pre id="curlExample" class="bg-gray-900 text-gray-100 p-4 rounded overflow-x-auto text-sm"><code>curl -X POST http://localhost:23456/v2/messages \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "from": "+1234567890",
    "to": "+0987654321",
    "text": "Hello from SmsSink!",
    "messaging_profile_id": "400017d2-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  }'</code></pre>
                </div>

                <!-- Request Format -->
                <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Request Format</h2>
                    <div class="bg-white p-4 rounded">
                        <h3 class="font-semibold text-sm mb-2">Required Fields:</h3>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 mb-4">
                            <li><code class="bg-gray-100 px-1 rounded">from</code> (string) - Sender phone number</li>
                            <li><code class="bg-gray-100 px-1 rounded">to</code> (string) - Recipient phone number</li>
                            <li><code class="bg-gray-100 px-1 rounded">messaging_profile_id</code> (string) - Messaging profile ID</li>
                            <li><code class="bg-gray-100 px-1 rounded">text</code> OR <code class="bg-gray-100 px-1 rounded">media_urls</code> - At least one must be present</li>
                        </ul>
                        <h3 class="font-semibold text-sm mb-2">Example Request Body:</h3>
                        <pre class="bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto text-xs"><code>{
  "from": "+1234567890",
  "to": "+0987654321",
  "text": "Your message text here",
  "media_urls": ["https://example.com/image.jpg"],
  "messaging_profile_id": "400017d2-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}</code></pre>
                    </div>
                </div>

                <!-- Response Format -->
                <div class="border-l-4 border-indigo-500 bg-indigo-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Success Response (200 OK)</h2>
                    <pre class="bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto text-xs"><code>{
  "data": {
    "id": "uuid-here",
    "from": "+1234567890",
    "to": "+0987654321",
    "text": "Your message text here",
    "media_urls": [],
    "messaging_profile_id": "400017d2-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "direction": "outbound",
    "created_at": "2024-01-01T12:00:00Z",
    "updated_at": "2024-01-01T12:00:00Z"
  }
}</code></pre>
                </div>

                <!-- Error Responses -->
                <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Error Responses</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-sm mb-1">401 Unauthorized (Missing Authorization Header)</h3>
                            <pre class="bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto text-xs"><code>{
  "errors": [
    {
      "code": "10001",
      "title": "Unauthorized",
      "detail": "Authorization header is required."
    }
  ]
}</code></pre>
                        </div>
                        <div>
                            <h3 class="font-semibold text-sm mb-1">422 Unprocessable Entity (Validation Error)</h3>
                            <pre class="bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto text-xs"><code>{
  "errors": [
    {
      "code": "10005",
      "title": "Invalid parameter",
      "detail": "The 'to' parameter is required."
    }
  ]
}</code></pre>
                        </div>
                    </div>
                </div>

                <!-- Quick Test -->
                <div class="border-l-4 border-teal-500 bg-teal-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Quick Test</h2>
                    <p class="text-sm text-gray-600 mb-3">Test the API directly from your browser console:</p>
                    <pre id="fetchExample" class="bg-gray-900 text-gray-100 p-3 rounded overflow-x-auto text-xs"><code>fetch('http://localhost:8080/v2/messages', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer your-api-key',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    from: '+1234567890',
    to: '+0987654321',
    text: 'Hello from browser!'
  })
})
.then(r => r.json())
.then(console.log);</code></pre>
                </div>

                <!-- Web UI -->
                <div class="border-l-4 border-gray-500 bg-gray-50 p-4 rounded">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Web UI</h2>
                    <p class="text-sm text-gray-600 mb-2">View all messages sent to the mock API:</p>
                    <a href="/" class="text-blue-600 hover:underline text-sm">http://localhost:23457/</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentApiKey = '';

        async function loadCredentials() {
            try {
                const response = await fetch('/api/credentials');
                if (!response.ok) throw new Error('Failed to fetch credentials');
                
                const cred = await response.json();
                currentApiKey = cred.api_key;
                
                document.getElementById('currentApiKey').textContent = cred.api_key;
                document.getElementById('authKeyPlaceholder').textContent = cred.api_key;
                
                if (cred.updated_at) {
                    const updated = new Date(cred.updated_at);
                    document.getElementById('lastUpdated').textContent = `Last updated: ${updated.toLocaleString()}`;
                }
                
                // Update examples
                updateExamples(cred.api_key);
            } catch (error) {
                console.error('Error loading credentials:', error);
                document.getElementById('currentApiKey').textContent = 'Error loading credentials';
            }
        }

        function updateExamples(apiKey) {
            // Update cURL example
            const curlExample = document.getElementById('curlExample').querySelector('code');
            curlExample.textContent = `curl -X POST http://localhost:23456/v2/messages \\
  -H "Authorization: Bearer ${apiKey}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "from": "+1234567890",
    "to": "+0987654321",
    "text": "Hello from SmsSink!",
    "messaging_profile_id": "400017d2-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  }'`;

            // Update fetch example
            const fetchExample = document.getElementById('fetchExample').querySelector('code');
            fetchExample.textContent = `fetch('http://localhost:23456/v2/messages', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ${apiKey}',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    from: '+1234567890',
    to: '+0987654321',
    text: 'Hello from browser!',
    messaging_profile_id: '400017d2-xxxx-xxxx-xxxx-xxxxxxxxxxxx'
  })
})
.then(r => r.json())
.then(console.log);`;
        }

        function copyApiKey() {
            const apiKey = document.getElementById('currentApiKey').textContent;
            navigator.clipboard.writeText(apiKey).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-gray-600');
                }, 2000);
            });
        }

        document.getElementById('credentialsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const apiKey = formData.get('api_key');
            const statusDiv = document.getElementById('saveStatus');

            try {
                const response = await fetch('/api/credentials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ api_key: apiKey })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error);
                }

                const cred = await response.json();
                statusDiv.innerHTML = '<span class="text-green-600">✓ API key updated successfully!</span>';
                statusDiv.classList.remove('text-red-600');
                statusDiv.classList.add('text-green-600');
                
                // Clear input
                document.getElementById('apiKeyInput').value = '';
                
                // Reload credentials
                await loadCredentials();
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);
            } catch (error) {
                statusDiv.innerHTML = `<span class="text-red-600">✗ Error: ${error.message}</span>`;
                statusDiv.classList.remove('text-green-600');
                statusDiv.classList.add('text-red-600');
            }
        });

        // Load credentials on page load
        loadCredentials();
    </script>
</body>
</html>
